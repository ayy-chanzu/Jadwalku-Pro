<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Jadwalku Pro ‚Äî Landscape + Break Time</title>
<script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
<style>
  :root{
    --card-bg: rgba(255,255,255,0.08);
    --accent: #6d28d9;
    --muted: rgba(255,255,255,0.85);
  }
  *{box-sizing:border-box}
  body{
    margin:0;
    min-height:100vh;
    font-family:Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
    background: linear-gradient(135deg,#0f172a,#081129);
    color:var(--muted);
    padding:20px;
  }

  .wrap{
    max-width:1600px;
    margin:0 auto;
  }

  header{
    display:flex;
    gap:16px;
    align-items:center;
    margin-bottom:16px;
  }
  header h1{margin:0;font-size:1.5rem;color:#fff}
  header p{margin:0;opacity:0.85;font-size:0.95rem}

  .control-panel{
    background:var(--card-bg);
    border-radius:14px;
    padding:16px;
    backdrop-filter: blur(6px);
    margin-bottom:16px;
    box-shadow:0 8px 24px rgba(7,10,22,0.4);
  }

  .controls{
    display:grid;
    grid-template-columns: 1fr 1fr;
    gap:12px;
    margin-bottom:12px;
  }

  select,input[type="text"],input[type="file"],button{
    padding:10px 14px;
    border-radius:8px;
    border: none;
    font-size:13px;
    height:42px;
    display:flex;
    align-items:center;
  }

  select{
    appearance: none;
    background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%23ffffff' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
    background-repeat: no-repeat;
    background-position: right 10px center;
    background-size: 20px;
    padding-right: 40px;
    cursor: pointer;
  }

  input[type="file"]{
    background:rgba(255,255,255,0.03); 
    color:var(--muted);
    padding:10px 14px;
  }

  .btn{
    background:linear-gradient(90deg,var(--accent),#2563eb);
    color:white;
    cursor:pointer;
    box-shadow:0 6px 18px rgba(37,99,235,0.12);
    padding:10px 14px;
    font-size:12px;
    white-space:nowrap;
    border-radius:8px;
    border:none;
  }
  .btn.ghost{
    background:transparent;
    border:1px solid rgba(255,255,255,0.08);
    color:var(--muted);
  }

  .btn:disabled{
    opacity:0.6;
    cursor:not-allowed;
  }

  .top-actions{
    display:flex;
    gap:8px;
    flex-wrap:wrap;
    justify-content:flex-start;
  }

  .main-content{
    display:grid;
    grid-template-columns: 1fr 320px;
    gap:16px;
  }

  .preview-card{
    min-height:500px;
    border-radius:14px;
    overflow:hidden;
    position:relative;
    box-shadow:0 10px 30px rgba(2,6,23,0.6);
    background:#0b1220;
  }

  #captureArea{
    width:100%;
    min-height:500px;
    position:relative;
    display:flex;
    flex-direction:column;
    gap:15px;
    justify-content:flex-start;
    padding:20px;
    background-size:cover;
    background-position:center;
    background-repeat:no-repeat;
  }

  #captureArea > *{
    position:relative;
    z-index:1;
  }

  .table-header{
    display:flex;
    justify-content:space-between;
    align-items:center;
    font-size:13px;
    gap:10px;
  }

  .table-header-left{
    background:rgba(0,0,0,0.35);
    padding:3px 6px;
    border-radius:3px;
    font-weight:bold;
    font-size:10px;
    white-space:nowrap;
  }

  .day-range-bar{
    padding:3px 6px;
    border-radius:3px;
    font-size:9px;
    color:#fff;
    font-weight:500;
    white-space:nowrap;
    display:inline-block;
    background:rgba(0,0,0,0.35);
  }

  .table-surface{
    width:100%;
    flex:0 1 auto;
    border-radius:12px;
    overflow:hidden;
    background:rgba(0,0,0,0.45);
    padding:0;
    display:flex;
    flex-direction:column;
    max-height:400px;
    overflow-y:auto;
    backdrop-filter:blur(8px);
  }

  table{
    width:100%;
    border-collapse:collapse;
    color:#fff;
    font-weight:600;
    table-layout:fixed;
    font-size:12px;
  }
  
  table thead{
    background:rgba(0,0,0,0.60);
    position:sticky;
    top:0;
    z-index:10;
  }

  table th{
    padding:10px 6px;
    border-right:1px solid rgba(255,255,255,0.06);
    text-align:center;
    font-size:11px;
    font-weight:700;
  }

  table th:last-child{
    border-right:none;
  }

  table td{
    padding:8px 6px;
    border-right:1px solid rgba(255,255,255,0.06);
    text-align:center;
    vertical-align:middle;
    border-bottom:1px solid rgba(255,255,255,0.06);
  }

  table td:last-child{
    border-right:none;
  }

  .jam-cell{
    font-weight:700;
    font-size:10px;
    background:rgba(0,0,0,0.50);
    color:#fff;
  }

  .mapel-chip{
    display:inline-block;
    padding:5px 8px;
    border-radius:4px;
    background-color:#14B8A6;
    color:#fff;
    font-weight:600;
    font-size:10px;
    text-align:center;
    white-space:nowrap;
    box-shadow:0 2px 8px rgba(0,0,0,0.3);
  }

  .break-row td{
    background:linear-gradient(90deg, #FFD700 0%, #FFC700 100%) !important;
    color:#000 !important;
    font-weight:700;
    padding:10px 6px !important;
    border-color:rgba(0,0,0,0.1) !important;
    font-size:11px;
  }

  footer{
    margin-top:16px;
    display:flex;
    justify-content:center;
    align-items:center;
    gap:8px;
    flex-wrap:wrap;
  }

  .note{
    font-size:8px;
    opacity:0.7;
    text-align:center;
    padding:3px 6px;
    background:rgba(255,255,255,0.05);
    border-radius:3px;
    white-space:nowrap;
    display:inline-block;
  }

  .sidebar{
    background:var(--card-bg);
    border-radius:14px;
    padding:16px;
    height:fit-content;
    max-height:calc(100vh - 280px);
    overflow-y:auto;
    backdrop-filter: blur(6px);
    box-shadow:0 8px 24px rgba(7,10,22,0.4);
  }

  .sidebar-section{
    margin-bottom:16px;
  }

  .small{font-size:11px;opacity:0.9;margin-bottom:6px;font-weight:600}

  .thumbs{display:flex;gap:6px;flex-wrap:wrap;margin-top:6px}
  .thumb{
    width:70px;height:48px;border-radius:6px;overflow:hidden;border:2px solid rgba(255,255,255,0.06);
    cursor:pointer;background-size:cover;background-position:center;
  }
  .thumb.selected{outline:2px solid rgba(99,102,241,0.9)}

  .controls-section{
    background:rgba(255,255,255,0.03);
    border-radius:8px;
    padding:10px;
    font-size:10px;
  }

  .controls-section h4{
    margin:0 0 6px 0;
    font-size:10px;
    font-weight:600;
  }

  .controls-section input{
    width:100%;
    padding:5px;
    margin-bottom:6px;
    font-size:10px;
  }

  .controls-section button{
    width:100%;
    padding:5px;
    font-size:10px;
    margin-top:6px;
  }

  .time-picker-container{
    display:flex;
    gap:4px;
    align-items:center;
    margin-bottom:6px;
    background:rgba(255,255,255,0.05);
    padding:4px;
    border-radius:4px;
  }

  .time-picker{
    flex:1;
    height:80px;
    overflow-y:scroll;
    background:rgba(0,0,0,0.3);
    border-radius:3px;
    scroll-behavior:smooth;
    display:flex;
    flex-direction:column;
    padding:15px 0;
  }

  .time-item{
    flex:0 0 26px;
    display:flex;
    align-items:center;
    justify-content:center;
    font-size:11px;
    font-weight:600;
    color:rgba(255,255,255,0.5);
    cursor:pointer;
    transition:all 0.2s;
  }

  .time-item.active{
    color:#fff;
    font-size:12px;
    background:rgba(109,40,217,0.3);
    border-radius:2px;
  }

  .time-item:hover{
    color:rgba(255,255,255,0.8);
  }

  .time-picker::-webkit-scrollbar{
    width:3px;
  }

  .time-picker::-webkit-scrollbar-thumb{
    background:rgba(99,102,241,0.5);
    border-radius:2px;
  }

  .color-legend{
    background:rgba(255,255,255,0.03);
    border-radius:8px;
    padding:8px;
    font-size:10px;
    max-height:150px;
    overflow-y:auto;
  }
  
  .legend-item{
    display:flex;
    align-items:center;
    gap:4px;
    margin-bottom:3px;
    padding:3px;
  }
  
  .legend-color{
    width:12px;
    height:12px;
    border-radius:2px;
  }

  #listJadwal{
    max-height:150px;
    overflow-y:auto;
    font-size:10px;
    background:rgba(255,255,255,0.02);
    border-radius:4px;
    padding:4px;
  }

  #listJadwal > div{
    padding:3px 4px;
    border-bottom:1px solid rgba(255,255,255,0.04);
    margin-bottom:3px;
  }

  #listJadwal .mapel-chip{
    padding:2px 5px;
    font-size:8px;
    margin-right:3px;
  }

  #listJadwal .break-item{
    background:#FFD700;
    color:#000;
    padding:2px 4px;
    border-radius:3px;
    font-size:8px;
    font-weight:700;
    display:flex;
    justify-content:space-between;
    align-items:center;
    gap:4px;
  }

  @media (max-width:768px){
    .controls{grid-template-columns:1fr}
    body{padding:12px}
  }

  .sidebar::-webkit-scrollbar,
  #listJadwal::-webkit-scrollbar,
  .color-legend::-webkit-scrollbar,
  .table-surface::-webkit-scrollbar{
    width:5px;
  }
  .sidebar::-webkit-scrollbar-thumb,
  #listJadwal::-webkit-scrollbar-thumb,
  .color-legend::-webkit-scrollbar-thumb,
  .table-surface::-webkit-scrollbar-thumb{
    background:rgba(99,102,241,0.5);
    border-radius:2px;
  }
</style>
</head>
<body>

<div class="wrap">
  <header>
    <div>
      <h1>üìÖ Jadwalku Pro</h1>
      <p>Landscape schedule dengan Jam Istirahat</p>
    </div>
  </header>

  <div class="control-panel">
    <!-- ‚úÖ BARIS 1: HARI & JAM (FULL WIDTH) -->
    <div class="controls">
      <select id="hari">
        <option value="" disabled selected>Pilih Hari</option>
        <option>Senin</option><option>Selasa</option><option>Rabu</option>
        <option>Kamis</option><option>Jumat</option><option>Sabtu</option>
      </select>

      <div id="jamPickerControl" style="display:none"></div>
    </div>

    <!-- ‚úÖ BARIS 2: NAMA MAPEL & FILE -->
    <div class="controls">
      <input type="text" id="mapel" placeholder="Nama Mapel">
      <input type="file" id="bgUpload" accept="image/*" multiple>
    </div>

    <div class="top-actions">
      <button class="btn" onclick="addData()">‚ûï Tambah Mapel</button>
      <button class="btn ghost" onclick="clearJadwal()">üóëÔ∏è Bersihkan</button>
      <button class="btn ghost" onclick="generateDesignBG()">üé® Generate BG</button>
      <button class="btn" onclick="downloadAs('png')">üì• PNG</button>
      <button class="btn" onclick="downloadAs('jpg')">üì• JPG</button>
    </div>
  </div>

  <div class="main-content">
    <div class="preview-card">
      <div id="captureArea">
        <div class="table-header">
          <div class="table-header-left">üìÖ Jadwal</div>
          <div id="dayRangeBar" class="day-range-bar">Senin - Sabtu</div>
        </div>

        <div class="table-surface">
          <table id="jadwalTableExport">
            <thead>
              <tr>
                <th style="width:12%">Jam</th>
                <th style="width:14.8%">Senin</th>
                <th style="width:14.8%">Selasa</th>
                <th style="width:14.8%">Rabu</th>
                <th style="width:14.8%">Kamis</th>
                <th style="width:14.8%">Jumat</th>
                <th style="width:14.8%">Sabtu</th>
              </tr>
            </thead>
            <tbody id="jadwalTableBody">
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <aside class="sidebar">
      <div class="sidebar-section">
        <div class="small">üñºÔ∏è BG</div>
        <div class="thumbs" id="thumbs"></div>
        <input type="file" id="bgUpload2" accept="image/*" multiple style="margin-top:6px;padding:5px;font-size:10px;width:100%" />
      </div>

      <div class="sidebar-section controls-section">
        <h4>‚è∏Ô∏è Istirahat</h4>
        
        <div class="time-picker-container">
          <div class="time-picker" id="breakTimePicker"></div>
        </div>

        <input type="text" id="breakName" placeholder="Nama" style="margin-bottom:6px">
        <button class="btn" onclick="addBreakFromSidebar()">Tambah</button>
      </div>

      <div class="sidebar-section">
        <div class="small">üìã List</div>
        <div id="listJadwal"></div>
      </div>

      <div class="sidebar-section">
        <div class="small">üé® Warna</div>
        <div class="color-legend">
          <div id="colorLegend"></div>
        </div>
      </div>
    </aside>
  </div>

  <footer>
    <div class="note">üí° Istirahat menutup seluruh baris dengan kuning</div>
  </footer>
</div>

<script>
  const backgrounds = [];
  let currentBgIndex = -1;
  let jadwal = [];
  const mapelColorAssignment = {};
  const LANDSCAPE_ASPECT_RATIO = 16 / 9;

  let selectedJam = '07:00';
  let selectedBreakJam = '07:00';

  const mapelColors = [
    '#EF4444','#FBBF24','#3B82F6','#10B981','#8B5CF6','#DC2626',
    '#06B6D4','#14B8A6','#D97706','#059669','#EC4899','#F97316',
  ];

  let usedColors = new Set();
  const hariList = ['Senin', 'Selasa', 'Rabu', 'Kamis', 'Jumat', 'Sabtu'];

  function $(sel){return document.querySelector(sel)}
  function esc(s){return (s+'').replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'})[m])}

  function generateHours(){
    const hours = [];
    for(let h = 7; h <= 15; h++){
      for(let m = 0; m < 60; m += 5){
        hours.push(`${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}`);
      }
    }
    return hours;
  }

  function initTimePicker(){
    const jamPickerControl = $('#jamPickerControl');
    jamPickerControl.innerHTML = `
      <div class="time-picker-container">
        <div class="time-picker" id="jamPicker"></div>
      </div>
    `;
    
    const jamPicker = $('#jamPicker');
    const hours = generateHours();
    
    hours.forEach(jam => {
      const item = document.createElement('div');
      item.className = 'time-item' + (jam === selectedJam ? ' active' : '');
      item.textContent = jam;
      item.onclick = () => selectJam(jam);
      jamPicker.appendChild(item);
    });
    
    jamPickerControl.style.display = 'block';
    scrollToActiveTime('jamPicker', selectedJam);

    const breakTimePicker = $('#breakTimePicker');
    breakTimePicker.innerHTML = '';
    
    hours.forEach(jam => {
      const item = document.createElement('div');
      item.className = 'time-item' + (jam === selectedBreakJam ? ' active' : '');
      item.textContent = jam;
      item.onclick = () => selectBreakJam(jam);
      breakTimePicker.appendChild(item);
    });
    
    scrollToActiveTime('breakTimePicker', selectedBreakJam);
  }

  function selectJam(jam){
    selectedJam = jam;
    const items = document.querySelectorAll('#jamPicker .time-item');
    items.forEach(item => item.classList.remove('active'));
    Array.from(items).find(item => item.textContent === jam).classList.add('active');
  }

  function selectBreakJam(jam){
    selectedBreakJam = jam;
    const items = document.querySelectorAll('#breakTimePicker .time-item');
    items.forEach(item => item.classList.remove('active'));
    Array.from(items).find(item => item.textContent === jam).classList.add('active');
  }

  function scrollToActiveTime(pickerId, jam){
    const picker = $(`#${pickerId}`);
    const items = picker.querySelectorAll('.time-item');
    const activeItem = Array.from(items).find(item => item.textContent === jam);
    if(activeItem){
      picker.scrollTop = activeItem.offsetTop - picker.clientHeight / 2 + activeItem.clientHeight / 2;
    }
  }

  function generateCuteCatParty(){
    const canvas = document.createElement('canvas');
    canvas.width = 1200;
    canvas.height = 675;
    const ctx = canvas.getContext('2d');

    const gradient = ctx.createLinearGradient(0, 0, 1200, 675);
    gradient.addColorStop(0, '#e8f4f8');
    gradient.addColorStop(0.5, '#f0f8fb');
    gradient.addColorStop(1, '#e8f4f8');
    ctx.fillStyle = gradient;
    ctx.fillRect(0, 0, 1200, 675);

    const drawCat = (x, y, size) => {
      ctx.fillStyle = '#fff8dc';
      ctx.beginPath();
      ctx.arc(x, y, size, 0, Math.PI * 2);
      ctx.fill();
      
      ctx.fillStyle = '#fff8dc';
      ctx.beginPath();
      ctx.moveTo(x - size * 0.6, y - size * 0.8);
      ctx.lineTo(x - size * 0.4, y - size * 1.2);
      ctx.lineTo(x - size * 0.2, y - size * 0.8);
      ctx.fill();
      
      ctx.beginPath();
      ctx.moveTo(x + size * 0.6, y - size * 0.8);
      ctx.lineTo(x + size * 0.4, y - size * 1.2);
      ctx.lineTo(x + size * 0.2, y - size * 0.8);
      ctx.fill();
      
      ctx.fillStyle = '#333';
      ctx.beginPath();
      ctx.arc(x - size * 0.3, y - size * 0.2, size * 0.15, 0, Math.PI * 2);
      ctx.fill();
      ctx.beginPath();
      ctx.arc(x + size * 0.3, y - size * 0.2, size * 0.15, 0, Math.PI * 2);
      ctx.fill();
      
      ctx.strokeStyle = '#333';
      ctx.lineWidth = 2;
      ctx.beginPath();
      ctx.arc(x, y + size * 0.2, size * 0.2, 0, Math.PI);
      ctx.stroke();
    };

    drawCat(150, 100, 45);
    drawCat(1050, 120, 40);
    drawCat(200, 550, 38);
    drawCat(950, 580, 42);

    const drawHeart = (x, y, size, color) => {
      ctx.fillStyle = color;
      ctx.beginPath();
      ctx.moveTo(x, y + size * 0.5);
      ctx.bezierCurveTo(x - size, y - size * 0.5, x - size * 1.5, y, x, y + size);
      ctx.bezierCurveTo(x + size * 1.5, y, x + size, y - size * 0.5, x, y + size * 0.5);
      ctx.fill();
    };

    drawHeart(600, 100, 25, '#ff69b4');
    drawHeart(550, 200, 20, '#ffb6c1');
    drawHeart(650, 180, 18, '#ff1493');

    return canvas.toDataURL('image/png');
  }

  function generateBlueStars(){
    const canvas = document.createElement('canvas');
    canvas.width = 1200;
    canvas.height = 675;
    const ctx = canvas.getContext('2d');

    const gradient = ctx.createLinearGradient(0, 0, 1200, 675);
    gradient.addColorStop(0, '#fffef0');
    gradient.addColorStop(1, '#f5f0e8');
    ctx.fillStyle = gradient;
    ctx.fillRect(0, 0, 1200, 675);

    const drawStar = (x, y, size, color, rotation = 0) => {
      ctx.save();
      ctx.translate(x, y);
      ctx.rotate(rotation);
      ctx.strokeStyle = color;
      ctx.lineWidth = 3;
      ctx.beginPath();
      for (let i = 0; i < 5; i++) {
        const angle = (i * 4 * Math.PI) / 5 - Math.PI / 2;
        const px = Math.cos(angle) * size;
        const py = Math.sin(angle) * size;
        i === 0 ? ctx.moveTo(px, py) : ctx.lineTo(px, py);
      }
      ctx.closePath();
      ctx.stroke();
      ctx.restore();
    };

    drawStar(100, 80, 30, '#6b7da1', 0);
    drawStar(200, 150, 25, '#8b9dc3', Math.PI / 4);
    drawStar(1100, 120, 28, '#5b6d91', Math.PI / 6);
    drawStar(150, 580, 26, '#7b8dab', Math.PI / 3);
    drawStar(1050, 600, 30, '#6b7da1', 0);
    drawStar(600, 100, 22, '#9badcb', Math.PI / 5);
    drawStar(700, 550, 24, '#8b9dc3', Math.PI / 8);

    ctx.strokeStyle = '#8b9dc3';
    ctx.lineWidth = 4;
    ctx.beginPath();
    ctx.moveTo(550, 250);
    ctx.quadraticCurveTo(600, 280, 650, 250);
    ctx.stroke();

    return canvas.toDataURL('image/png');
  }

  function generateBlackStars3D(){
    const canvas = document.createElement('canvas');
    canvas.width = 1200;
    canvas.height = 675;
    const ctx = canvas.getContext('2d');

    const gradient = ctx.createLinearGradient(0, 0, 1200, 675);
    gradient.addColorStop(0, '#f8f8f8');
    gradient.addColorStop(1, '#e8e8e8');
    ctx.fillStyle = gradient;
    ctx.fillRect(0, 0, 1200, 675);

    const draw3DStar = (x, y, size) => {
      ctx.fillStyle = '#cccccc';
      ctx.beginPath();
      for (let i = 0; i < 5; i++) {
        const angle = (i * 4 * Math.PI) / 5 - Math.PI / 2;
        const px = Math.cos(angle) * size;
        const py = Math.sin(angle) * size;
        i === 0 ? ctx.moveTo(px + 5, py + 5) : ctx.lineTo(px + 5, py + 5);
      }
      ctx.closePath();
      ctx.fill();

      ctx.fillStyle = '#000';
      ctx.beginPath();
      for (let i = 0; i < 5; i++) {
        const angle = (i * 4 * Math.PI) / 5 - Math.PI / 2;
        const px = Math.cos(angle) * size;
        const py = Math.sin(angle) * size;
        i === 0 ? ctx.moveTo(px, py) : ctx.lineTo(px, py);
      }
      ctx.closePath();
      ctx.fill();
    };

    draw3DStar(100, 80, 35);
    draw3DStar(1050, 100, 32);
    draw3DStar(150, 580, 30);
    draw3DStar(950, 600, 36);
    draw3DStar(600, 150, 28);
    draw3DStar(700, 520, 26);

    ctx.fillStyle = '#cccccc';
    ctx.beginPath();
    ctx.arc(850, 200, 18, 0, Math.PI * 2);
    ctx.fill();

    ctx.fillStyle = '#fff';
    ctx.beginPath();
    ctx.arc(850, 200, 12, 0, Math.PI * 2);
    ctx.fill();

    return canvas.toDataURL('image/png');
  }

  function generatePinkButterfly(){
    const canvas = document.createElement('canvas');
    canvas.width = 1200;
    canvas.height = 675;
    const ctx = canvas.getContext('2d');

    const gradient = ctx.createLinearGradient(0, 0, 1200, 675);
    gradient.addColorStop(0, '#fce4ec');
    gradient.addColorStop(0.5, '#f8bbd0');
    gradient.addColorStop(1, '#fce4ec');
    ctx.fillStyle = gradient;
    ctx.fillRect(0, 0, 1200, 675);

    const drawButterfly = (x, y, scale) => {
      ctx.save();
      ctx.translate(x, y);
      ctx.scale(scale, scale);

      ctx.fillStyle = '#ff69b4';
      ctx.beginPath();
      ctx.ellipse(-40, -30, 50, 80, -Math.PI / 6, 0, Math.PI * 2);
      ctx.fill();

      ctx.fillStyle = '#ffb6c1';
      ctx.beginPath();
      ctx.ellipse(-40, 30, 40, 60, Math.PI / 6, 0, Math.PI * 2);
      ctx.fill();

      ctx.fillStyle = '#ff69b4';
      ctx.beginPath();
      ctx.ellipse(40, -30, 50, 80, Math.PI / 6, 0, Math.PI * 2);
      ctx.fill();

      ctx.fillStyle = '#ffb6c1';
      ctx.beginPath();
      ctx.ellipse(40, 30, 40, 60, -Math.PI / 6, 0, Math.PI * 2);
      ctx.fill();

      ctx.fillStyle = '#fff';
      ctx.beginPath();
      ctx.ellipse(0, 0, 15, 40, 0, 0, Math.PI * 2);
      ctx.fill();

      ctx.restore();
    };

    drawButterfly(200, 150, 1.2);
    drawButterfly(1000, 200, 1);
    drawButterfly(250, 550, 0.9);
    drawButterfly(950, 520, 1.1);

    ctx.fillStyle = '#fff';
    for(let i = 0; i < 8; i++){
      const spx = Math.random() * 1200;
      const spy = Math.random() * 675;
      ctx.beginPath();
      ctx.arc(spx, spy, 4, 0, Math.PI * 2);
      ctx.fill();
    }

    return canvas.toDataURL('image/png');
  }

  function generateBunga(){
    const canvas = document.createElement('canvas');
    canvas.width = 1200;
    canvas.height = 675;
    const ctx = canvas.getContext('2d');

    const gradient = ctx.createLinearGradient(0, 0, 1200, 675);
    gradient.addColorStop(0, '#f5e6f0');
    gradient.addColorStop(0.5, '#fce4ec');
    gradient.addColorStop(1, '#f3e5f5');
    ctx.fillStyle = gradient;
    ctx.fillRect(0, 0, 1200, 675);

    const drawFlower = (x, y, size, color) => {
      ctx.fillStyle = color;
      ctx.beginPath();
      ctx.arc(x, y, size, 0, Math.PI * 2);
      ctx.fill();
      
      ctx.fillStyle = color.replace(')', ', 0.6)').replace('rgb', 'rgba');
      for(let i = 0; i < 5; i++){
        const px = x + Math.cos(i * Math.PI * 2 / 5) * size * 1.3;
        const py = y + Math.sin(i * Math.PI * 2 / 5) * size * 1.3;
        ctx.beginPath();
        ctx.arc(px, py, size * 0.6, 0, Math.PI * 2);
        ctx.fill();
      }
    };

    drawFlower(200, 80, 40, '#e91e63');
    drawFlower(380, 120, 35, '#ec407a');
    drawFlower(450, 60, 30, '#f48fb1');
    drawFlower(950, 150, 38, '#ad1457');
    drawFlower(850, 380, 40, '#f50057');
    drawFlower(950, 480, 32, '#e91e63');

    return canvas.toDataURL('image/png');
  }

  function generateFrame(){
    const canvas = document.createElement('canvas');
    canvas.width = 1200;
    canvas.height = 675;
    const ctx = canvas.getContext('2d');

    const gradient = ctx.createLinearGradient(0, 0, 1200, 675);
    gradient.addColorStop(0, '#e3f2fd');
    gradient.addColorStop(1, '#f3e5f5');
    ctx.fillStyle = gradient;
    ctx.fillRect(0, 0, 1200, 675);

    ctx.strokeStyle = '#4a6fa5';
    ctx.lineWidth = 8;
    ctx.beginPath();
    ctx.moveTo(80, 80);
    ctx.lineTo(1120, 80);
    ctx.lineTo(1120, 595);
    ctx.lineTo(80, 595);
    ctx.closePath();
    ctx.stroke();

    const drawSparkle = (x, y) => {
      ctx.fillStyle = '#4a6fa5';
      ctx.beginPath();
      ctx.arc(x, y, 8, 0, Math.PI * 2);
      ctx.fill();
      ctx.fillStyle = '#7986cb';
      ctx.beginPath();
      ctx.arc(x, y, 4, 0, Math.PI * 2);
      ctx.fill();
    };

    drawSparkle(80, 80);
    drawSparkle(1120, 80);
    drawSparkle(80, 595);
    drawSparkle(1120, 595);

    ctx.strokeStyle = '#90caf9';
    ctx.lineWidth = 3;
    ctx.beginPath();
    ctx.moveTo(120, 120);
    ctx.lineTo(1080, 120);
    ctx.stroke();
    ctx.beginPath();
    ctx.moveTo(120, 555);
    ctx.lineTo(1080, 555);
    ctx.stroke();

    return canvas.toDataURL('image/png');
  }

  function generateDesignBG(){
    const designs = [
      {name: 'Bunga Pink', fn: generateBunga},
      {name: 'Frame Blue', fn: generateFrame},
      {name: 'Cute Cat Party', fn: generateCuteCatParty},
      {name: 'Blue Stars', fn: generateBlueStars},
      {name: 'Black Stars 3D', fn: generateBlackStars3D},
      {name: 'Pink Butterfly', fn: generatePinkButterfly}
    ];

    const design = designs[Math.floor(Math.random() * designs.length)];
    const url = design.fn();

    addBackground({name: design.name, url: url});
    currentBgIndex = backgrounds.length - 1;
    renderThumbs();
    applyCurrentBackground();
    alert(`‚úÖ BG: ${design.name} diterapkan!`);
  }

  function getMapelColor(mapel){
    if(mapelColorAssignment[mapel]) return mapelColorAssignment[mapel];
    for(let c of mapelColors){
      if(!usedColors.has(c)){
        mapelColorAssignment[mapel]=c;
        usedColors.add(c);
        return c;
      }
    }
    return mapelColors[0];
  }

  function addData(){
    const h=$('#hari').value;
    const j=selectedJam;
    const m=$('#mapel').value.trim();
    if(!h||!j||!m){
      alert('Isi semua field!');
      return;
    }
    const c=getMapelColor(m);
    jadwal.push({hari:h, jam:j, mapel:m, color:c, isBreak:false});
    renderTable();
    renderList();
    renderLegend();
    $('#mapel').value='';
    $('#hari').value='';
  }

  function addBreakFromSidebar(){
    const j=selectedBreakJam;
    const n=$('#breakName').value.trim() || 'Istirahat';
    if(!j){
      alert('Pilih jam!');
      return;
    }
    
    jadwal = jadwal.filter(r => r.jam !== j);
    jadwal.push({jam:j, mapel:n, isBreak:true, color:'#FFD700'});
    
    renderTable();
    renderList();
    renderLegend();
    $('#breakName').value = '';
  }

  function renderTable(){
    const tb=$('#jadwalTableBody');
    tb.innerHTML='';
    
    if(jadwal.length===0){
      const tr=document.createElement('tr');
      tr.innerHTML=`<td colspan="7" style="padding:20px;color:rgba(255,255,255,0.7);text-align:center;font-size:11px">Belum ada jadwal</td>`;
      tb.appendChild(tr);
      return;
    }

    const sortedJadwal = [...jadwal].sort((a,b) => a.jam.localeCompare(b.jam));
    const jamSet = new Set(sortedJadwal.map(r=>r.jam));
    const jamList = Array.from(jamSet);
    
    jamList.forEach(j=>{
      const tr=document.createElement('tr');
      const breakItem = sortedJadwal.find(r => r.jam===j && r.isBreak);
      
      if(breakItem){
        tr.className = 'break-row';
        let rowHTML = `<td class="jam-cell">${esc(j)}</td>`;
        for(let i=0; i<6; i++){
          rowHTML += `<td>${esc(breakItem.mapel)}</td>`;
        }
        tr.innerHTML = rowHTML;
      } else {
        let rowHTML = `<td class="jam-cell">${esc(j)}</td>`;
        hariList.forEach(h=>{
          const jadwalHari = sortedJadwal.find(r => r.hari===h && r.jam===j && !r.isBreak);
          if(jadwalHari){
            const chipHTML=`<span class="mapel-chip" style="background-color:${jadwalHari.color}">${esc(jadwalHari.mapel)}</span>`;
            rowHTML += `<td>${chipHTML}</td>`;
          } else {
            rowHTML += `<td>-</td>`;
          }
        });
        tr.innerHTML = rowHTML;
      }
      tb.appendChild(tr);
    });
  }

  function renderList(){
    const el=$('#listJadwal');
    el.innerHTML='';
    if(jadwal.length===0){el.innerHTML='<div style="opacity:0.8;text-align:center;padding:6px">Kosong</div>';return;}
    
    const sorted = [...jadwal].sort((a,b) => a.jam.localeCompare(b.jam));
    sorted.forEach((r)=>{
      const d=document.createElement('div');
      
      if(r.isBreak){
        d.innerHTML=`<div class="break-item">
                       <span>${esc(r.jam)} - ${esc(r.mapel)}</span>
                       <button onclick="removeJadwal('${r.jam}')" style="background:0;border:0;color:inherit;cursor:pointer;opacity:0.6;font-size:9px;padding:0;width:14px;height:14px;">√ó</button>
                     </div>`;
      } else {
        d.innerHTML=`<div style="display:flex;gap:3px;justify-content:space-between;align-items:center;margin-bottom:2px">
                       <div style="flex:1">
                         <div style="font-size:8px;margin-bottom:1px"><strong>${esc(r.hari)}</strong> ${esc(r.jam)}</div>
                         <span class="mapel-chip" style="background-color:${r.color}">${esc(r.mapel)}</span>
                       </div>
                       <button onclick="removeJadwal('${r.jam}','${r.hari}')" style="background:0;border:0;color:inherit;cursor:pointer;opacity:0.6;font-size:9px;padding:0;width:14px;height:14px;">√ó</button>
                     </div>`;
      }
      el.appendChild(d);
    });
  }

  function renderLegend(){
    const el=$('#colorLegend');
    el.innerHTML='';
    const unique=[...new Set(jadwal.filter(r=>!r.isBreak).map(r=>r.mapel))];
    if(unique.length===0){el.innerHTML='<div style="opacity:0.7;text-align:center;padding:6px;font-size:9px">-</div>';return;}
    unique.forEach(m=>{
      const c=mapelColorAssignment[m];
      const item=document.createElement('div');
      item.className='legend-item';
      item.innerHTML=`<div class="legend-color" style="background-color:${c}"></div><span style="font-size:9px">${esc(m)}</span>`;
      el.appendChild(item);
    });
  }

  function removeJadwal(jam, hari){
    let removeIdx = -1;
    
    if(hari){
      removeIdx = jadwal.findIndex(r => r.jam === jam && r.hari === hari && !r.isBreak);
    } else {
      removeIdx = jadwal.findIndex(r => r.jam === jam && r.isBreak);
    }
    
    if(removeIdx !== -1){
      const removed = jadwal[removeIdx];
      if(!removed.isBreak){
        const m = removed.mapel;
        if(!jadwal.some((r,idx) => idx !== removeIdx && r.mapel === m && !r.isBreak)){
          const c = mapelColorAssignment[m];
          delete mapelColorAssignment[m];
          usedColors.delete(c);
        }
      }
      jadwal.splice(removeIdx, 1);
      renderTable();
      renderList();
      renderLegend();
    }
  }

  function clearJadwal(){
    if(!confirm('Bersihkan jadwal?'))return;
    jadwal = [];
    Object.keys(mapelColorAssignment).forEach(k => delete mapelColorAssignment[k]);
    usedColors.clear();
    renderTable();
    renderList();
    renderLegend();
  }

  function addBackground(obj){
    if(backgrounds.find(b=>b.url===obj.url))return;
    backgrounds.push({id:Date.now()+Math.random(),name:obj.name||'bg',url:obj.url});
    if(currentBgIndex===-1)currentBgIndex=0;
  }

  async function handleFiles(files){
    for(const f of files){
      const r=new FileReader();
      r.onload=async (e)=>{
        try{
          addBackground({name:f.name,url:e.target.result});
          renderThumbs();
          applyCurrentBackground();
        }catch(err){
          console.error('Error:', err);
          alert('Gagal memproses gambar');
        }
      };
      r.readAsDataURL(f);
    }
  }

  document.getElementById('bgUpload').addEventListener('change',(e)=>handleFiles(e.target.files));
  document.getElementById('bgUpload2').addEventListener('change',(e)=>handleFiles(e.target.files));

  function renderThumbs(){
    const c=$('#thumbs');
    c.innerHTML='';
    backgrounds.forEach((b,i)=>{
      const d=document.createElement('div');
      d.className='thumb'+(i===currentBgIndex?' selected':'');
      d.style.backgroundImage=`url('${b.url}')`;
      d.title=b.name;
      d.onclick=()=>{currentBgIndex=i;applyCurrentBackground();renderThumbs();};
      c.appendChild(d);
    });
  }

  function applyCurrentBackground(){
    const cap=$('#captureArea');
    if(currentBgIndex>=0&&backgrounds[currentBgIndex]){
      cap.style.backgroundImage=`url('${backgrounds[currentBgIndex].url}')`;
    }else{
      cap.style.backgroundImage='none';
    }
  }

  async function downloadAs(type='png'){
    const c=$('#captureArea');
    const opts={scale:2,useCORS:true,backgroundColor:null,logging:false};
    try{
      const cv=await html2canvas(c,opts);
      if(type==='png'){
        downloadDataURL(cv.toDataURL('image/png'),`jadwal-${Date.now()}.png`);
      }else{
        const jc=document.createElement('canvas');
        jc.width=cv.width;
        jc.height=cv.height;
        const ctx=jc.getContext('2d');
        ctx.fillStyle='#ffffff';
        ctx.fillRect(0,0,jc.width,jc.height);
        ctx.drawImage(cv,0,0);
        downloadDataURL(jc.toDataURL('image/jpeg',0.92),`jadwal-${Date.now()}.jpg`);
      }
    }catch(e){alert('Gagal download');console.error(e);}
  }

  function downloadDataURL(url,fn){
    const a=document.createElement('a');
    a.href=url;
    a.download=fn;
    document.body.appendChild(a);
    a.click();
    a.remove();
  }

  renderTable();
  renderList();
  renderLegend();
  initTimePicker();
</script>

</body>
</html>